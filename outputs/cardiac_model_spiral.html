<!doctype html>
<html>
    <head>
        <script src='./Abubu.js'
            type='text/javascript'></script>
            </head>

            <body>
            <canvas id=canvas_1 width=512 height=512 style="border: 1px solid black">
            Your browser doesn't support HTML5.0
            </canvas>
            <canvas id=canvas_2 width=512 height=256 style="border: 1px solid black">
            Your browser doesn't support HTML5.0
            </canvas>

        <p style="position: absolute; top: 540px; width:100%; text-align: left"> Select a IC file : <input type='file' id="myFileIC"></p>
        <button style="position: absolute;top: 600px" onclick='processFile2()'>Load IC</button>

<script id='click' type='x-shader-fragment'>#version 300 es
precision highp float ;
precision highp int ;

uniform sampler2D   inTexture ;
uniform vec2    clickPosition ;
uniform float   clickRadius ;

in vec2 cc, pixPos ;

layout (location = 0) out vec4 ocolor ;

#define u   color.r

// Main body of the shader
void main() {
    vec2  size  = vec2(textureSize(inTexture, 0)) ;

    // read the color of the pixel .......................................
    vec4 color = texture( inTexture , cc ) ;

    if ( length(clickPosition - cc )< clickRadius ){
        u = 1. ;
    }

    // output the color of the pixel .....................................
    ocolor = color ;
    return ;
}

</script><script id='init' type='shader'>#version 300 es
precision highp float ;
precision highp int ;

in vec2 cc, pixPos ;

layout (location = 0) out vec4 color1 ;
layout (location = 1) out vec4 color2 ;

// Main body of the shader
void main() {
    vec4 color = vec4(0.) ;

    color.r = 0. ;
	color.g = 1. ;
	color.b = 1. ;

    // added lines for S1-S2 initialization
    if ( cc.x < 0.1 ){
        color.r = 1. ;
    }
    // added lines for S1-S2 initialization

	color1 = color ;
    color2 = color ;


    return ;
}
</script>


<script id='initS1S2' type='shader'>#version 300 es
precision highp float ;
precision highp int ;

uniform sampler2D   inTexture ;

in vec2 cc, pixPos ;

layout (location = 0) out vec4 color1 ;
layout (location = 1) out vec4 color2 ;

// Main body of the shader
void main() {
    vec4 color = texture(inTexture, cc) ;
    if ( cc.y < 0.5 ){
        color.r = 1. ;
    }
	color1 = color ;


    return ;
}
</script>

<script id='march' type='shader'>#version 300 es
precision highp float ;
precision highp int ;

uniform sampler2D   inTexture ;
uniform float       dt, diffCoef, currtime, Lx, Ly,Temp;

in vec2 cc, pixPos ;

layout (location = 0) out vec4 ocolor ;

#define u       color.r
#define v       color.g
#define w       color.b

// Main body of the shader
void main() {
    vec2  size  = vec2(textureSize(inTexture, 0)) ;
    float dx    = Lx/size.x ;
    float dy    = Ly/size.y ;

    vec2 ii = vec2(1.,0.)/size ;
    vec2 jj = vec2(0.,1.)/size ;

    // read the color of the pixel .......................................
    vec4 color = texture( inTexture , cc ) ;

    // Standard Laplacian calculation (Replaces the LR/UD/E-field map logic)
    float laplacian = (
        texture(inTexture, cc + ii).r +
        texture(inTexture, cc - ii).r +
        texture(inTexture, cc + jj).r +
        texture(inTexture, cc - jj).r -
        4.0 * u
    ) / (dx*dx) ;

    float dudt = diffCoef*laplacian ;

    // Original 3V Model Constants and Logic ---------------------------
    float tau_pv=7.99;
    float tau_v1=9.8;
    float tau_v2=312.5;
    float tau_pw=870.0;
    float tau_mw=41.0;
    float tau_d=0.5714;
    float tau_0=12.5;
    float tau_r=33.83;
    float tau_si=29.0;
    float K=10.0;
    float V_csi=0.861;
    float V_c=0.13;
    float V_v=0.04;
    float C_m=1.0;

    float T0=37.0;
    float q10v=1.5;
    float q10w=2.45;
    float betafi=0.065;
    float betaso=0.008;
    float betasi=0.008;
    float phiv = pow(q10v,(Temp-T0)/10.0);
    float phiw = pow(q10w,(Temp-T0)/10.0);
    float etafi = 1.0+betafi*(Temp-T0);
    float etaso = 1.0+betaso*(Temp-T0);
    float etasi = 1.0+betasi*(Temp-T0);

    float p = step(V_c, u) ;
    float q = step(V_v, u) ;

    float tau_mv = (1.0-q)*tau_v1   +  q*tau_v2 ;
    float tn = tanh(K*(u-V_csi));

    //Rush-Larsen for gating variables
    v = (1.0-p)*(1.0-(1.0-v)*exp(-phiv*dt/tau_mv)) + p*v*exp(-phiv*dt/tau_pv);
    w = (1.0-p)*(1.0-(1.0-w)*exp(-phiw*dt/tau_mw)) + p*w*exp(-phiw*dt/tau_pw);

    float Ifi  = etafi*(-v*p*(u - V_c)*(1.0-u)/tau_d) ;
    float Iso  = etaso*(u*(1.0  - p )/tau_0 + p/tau_r) ;
    float Isi  = etasi*(-w*(1.0  + tn) /(2.0*tau_si)) ;

    dudt  -= (Ifi+Iso+Isi)/C_m ;

    u += dt*dudt;

    if(u>3.) u=3.;
    if(u<-3.) u=-3.;

    ocolor = color ;
    return ;
}
</script>

<script>
function source(id){
    return document.getElementById(id).text ;
}

var canvas_1 = document.getElementById('canvas_1') ;
canvas_1.style.left = "10px";
canvas_1.style.top = "10px";
canvas_1.style.position = "absolute";

var canvas_2 = document.getElementById('canvas_2') ;
canvas_2.style.left = "532px";
canvas_2.style.top = "10px";
canvas_2.style.position = "absolute";

var env = {
        dt : 0.025 ,
        diffCoef :0.001,
        time : 0 ,
		Lx : 10.,
		Ly : 10.,
        running : false ,
		width : 512,
		height : 512,
		clickRadius : 0.06 ,
		clickPosition  : [0.,0.] ,
        Temp : 37.0,
		skip : 40,
  } ;

// defining the textures .................................................
var fcolor = new Abubu.Float32Texture(env.width,env.height) ;
var scolor = new Abubu.Float32Texture(env.width,env.height) ;

// Setup a solver ........................................................
var init = new Abubu.Solver( {
    fragmentShader  : source('init'),
    targets : {
        color1 : { location :0, target : fcolor  } ,
        color2 : { location :1, target : scolor  } ,
    }
} ) ;
init.render();

// added lines for S1-S2 initialization
var initS1S2 = new Abubu.Solver( {
    fragmentShader  : source('initS1S2'),
    uniforms : {
        inTexture : { type : 't' , value : fcolor } ,
    } ,
    targets : {
        color1 : { location :0, target : scolor  } ,
    }
} ) ;

var turn_red_first = false;
var turn_red_second = false;
var measurePoint = 525312;
// added lines for S1-S2 initialization

// post processing .......................................................
var plot = new Abubu.Plot2D({
    target : fcolor,
    prevTarget: scolor,
    channel : 'r',
    minValue : -1.0 ,
    maxValue : 1.0 ,
    colorbar : true ,
    probeVisible : true ,
    canvas : canvas_1 ,
}) ;
plot.init() ;
plot.render() ;

var splot = new Abubu.SignalPlot({
    noPltPoints : 1024,
    grid : 'on',
    nx   : 4 ,
    ny   : 5 ,
    xticks : { mode : 'auto', unit : 'ms', font : '11pt Times' } ,
    yticks : { mode : 'auto', unit : '' , font : '12pt Times',precision : 1  } ,
    canvas : canvas_2,
} ) ;

env.usgn = splot.addSignal( fcolor, {
    channel : 'r',
    minValue : -1.0,
    maxValue : 2.5 ,
    restValue : 0 ,
    color : [ 1.,0.,0.0 ],
    visible : true ,
    timewindow : 1000 ,
    probePosition : [0.5,0.5]
} ) ;
splot.init() ;

function marchUniforms(_inTexture){
    this.inTexture          = { type : 't', value : _inTexture          } ;
    this.dt                 = { type : 'f', value : env.dt              } ;
    this.diffCoef           = { type : 'f', value : env.diffCoef        } ;
    this.currtime           = { type : 'f', value : env.time          } ;
	this.Lx                 = { type : 'f', value : env.Lx          } ;
	this.Ly                 = { type : 'f', value : env.Ly          } ;
    this.Temp               = { type : 'f', value : env.Temp          } ;
    return this ;
}

var fmarch = new Abubu.Solver({
        fragmentShader : source( 'march' ) ,
		uniforms : new marchUniforms( fcolor ) ,
        targets : { ocolor : { location : 0, target : scolor } }
    } ) ;

var smarch = new Abubu.Solver({
        fragmentShader : source( 'march' ) ,
  		uniforms : new marchUniforms( scolor ) ,
        targets : { ocolor : { location : 0, target : fcolor } }
    } ) ;

function march(){
    fmarch.uniforms['currtime'].value = env.time ;
    fmarch.render() ;
    env.time += env.dt ;
    smarch.uniforms['currtime'].value = env.time ;
    smarch.render() ;
    env.time += env.dt ;
}

// added lines for S1-S2 initialization
function S1S2Init(){
    if (!turn_red_first && fcolor.value[measurePoint] >= 0.9){
        turn_red_first = true;
    }
    if (turn_red_first && !turn_red_second && fcolor.value[measurePoint] < 0.1){
        turn_red_second = true;
        initS1S2.render() ;
        clickCopy.render() ;
    }
}
// added lines for S1-S2 initialization

j=0;
function run(){
    if (env.running){
        for(var i = 0 ; i<env.skip ; i++){
            march() ;
            if (j % 10 == 0) {
                S1S2Init(); // added lines for S1-S2 initialization
            }
            env.usgn.update(env.time) ;
            j += 1;
        }
    }
    splot.render() ;
    plot.render() ;
    requestAnimationFrame(run) ;
}

// click solver ..........................................................
var click = new Abubu.Solver({
    fragmentShader : source( 'click' ) ,
    uniforms : {
        inTexture : { type : 't', value : fcolor } ,
        clickRadius: { type : 'f', value : env.clickRadius } ,
        clickPosition: { type : 'v2', value : env.clickPosition } ,
    } ,
    targets : { ocolor : { location : 0 , target : scolor } }
} ) ;

var clickCopy = new Abubu.Copy( scolor, fcolor ) ;

new Abubu.MouseListener({
    canvas : canvas_1 ,
    event : 'drag' ,
    callback : function(e){
        click.uniforms.clickPosition.value = e.position ;
        click.render() ;
        clickCopy.render() ;
    }
} ) ;


env.initialize = function(){
    env.time = 0 ;
    init.render() ;
    splot.init() ;
    env.usgn.init(0) ;
    plot.init() ;
    // Reset S1-S2 variables
    turn_red_first = false;
    turn_red_second = false;
}

function addToGui(guiElemenent, obj, paramList, solverList){
    var elements = {} ;
    for(i in paramList){
        var param = paramList[i] ;
        elements[param] = guiElemenent.add(obj, param )  ;
        elements[param].onChange(function(){
            Abubu.setUniformInSolvers(this.property, this.object[this.property], solverList) ;
        } ) ;
    }
    return elements ;
}

function processFile2(){
    var file = document.querySelector("#myFileIC").files[0] ;
    var reader = new FileReader() ;
    reader.readAsText(file) ;
    reader.onload = function(event){
        var result  = event.target.result ;
        var data = result.split(',') ;
        var width = parseInt(data[0]) ;
        var height = parseInt(data[1]) ;
        var table = new Float32Array(width*height*4) ;
        var p = 0 ;
        for (var i=2 ; i< data.length; i++) table[p++] = parseFloat( data[i]) ;
        fcolor.data = table ;
        scolor.data = table ;
    }
}

function createGui(){
    var gui = new Abubu.Gui() ;
    var panel = gui.addPanel({width:300}) ;

    var mod = panel.addFolder('Model param') ;
    addToGui( mod, env, ['Temp'], [fmarch, smarch] ) ;

    var exe = panel.addFolder('Execution') ;
    exe.add(env,'time').listen() ;
    exe.add(env,'skip') ;
    exe.add(env,'initialize') ;
    exe.add(env,'running').listen() ;
    exe.open() ;
}

createGui() ;
run() ;

</script>
</body>
</html>
